"use strict";TetraBloc.Jeu=function(e){this.tempsTxt,this.scoreTxt,this.niveauTxt,this.toucheRotation,this.I_BLOC_COULEUR=11393254,this.O_BLOC_COULEUR=16776960,this.T_BLOC_COULEUR=8388736,this.S_BLOC_COULEUR=32768,this.Z_BLOC_COULEUR=16711680,this.J_BLOC_COULEUR=255,this.L_BLOC_COULEUR=16753920},TetraBloc.Jeu.prototype={init:function(){this.niveauLimite=!1,this.tempsLimite=!1,this.reserveUtilise=!1,this.laPieceEnReserve=null,this.laProchainePiece=null,this.laPieceMettreEnJeu=null,this.laForme=[],this.laProchaineForme=[],this.reserveForme=[],this.score=0,this.laMusique=this.game.add.audio("musique"),this.nbLignesDetruitesDunCoup=0,this.nbLignesDetruitesTotal=0,this.vitesse=2,this.laBoucleTemps=null,this.tempsEcoule=0,this.niveau=1,this.etatPiece=0,this.etatRotation=0,this.blocActif=!0,this.leTemps=0,this.freqTemp=.07,this.prochaineAction=0,this.lesCases=[],this.tableauJeu=[],this.tableauProchainePiece=[],this.lesCasesProchainePieces=[],this.tableauPieceEnReserve=[],this.lesCasesPieceEnReserve=[],this.objetPause={}},create:function(){this.toucheRotation=this.game.input.keyboard.addKey(Phaser.Keyboard.Z),this.touchePause=this.game.input.keyboard.addKey(Phaser.Keyboard.P),this.toucheMettreEnReserve=this.game.input.keyboard.addKey(Phaser.Keyboard.SHIFT),this.lesFleches=this.game.input.keyboard.createCursorKeys();var e=Math.round(20*TetraBloc.RATIO_ECRAN.moyen)+"px Monospace",t={font:e,fill:"#AAAAAA",align:"center"},i=this.game.add.sprite(0,0,"fondEcran");i.scale.set(TetraBloc.RATIO_ECRAN.horizontal,TetraBloc.RATIO_ECRAN.vertical),this.scoreTxt=this.game.add.text(this.game.width/1.35,290*TetraBloc.RATIO_ECRAN.vertical,"Score:  "+this.score,t),this.scoreTxt.anchor.set(0,0),this.niveauTxt=this.game.add.text(this.game.width/1.35,330*TetraBloc.RATIO_ECRAN.vertical,"Niveau: "+this.niveau,t),this.niveauTxt.anchor.set(0,0),this.tempsTxt=this.game.add.text(this.game.width/1.35,370*TetraBloc.RATIO_ECRAN.vertical,"Temps:  "+this.tempsEcoule,t),this.tempsTxt.anchor.set(0,0),this.affecterMode(),this.creerJeu(),this.game.device.desktop||this.creerBoutons(),this.game.time.events.loop(Phaser.Timer.SECOND,this.augmenterTemps,this),this.creerUnBloc(),this.laMusique.loop=!0,this.laMusique.play()},update:function(){this.leTemps=this.game.time.totalElapsedSeconds(),this.blocActif&&(this.lesFleches.left.isDown&&this.bougerGauche(),this.lesFleches.right.isDown&&this.bougerDroite(),this.lesFleches.down.isDown&&this.bougerBas()),this.toucheRotation.onDown.add(this.faireRotation,this),this.toucheMettreEnReserve.onDown.add(this.mettreEnReserve,this),this.touchePause.onDown.add(this.mettreSurPause,this)},mettreSurPause:function(){if(this.blocActif=!this.blocActif,this.blocActif)document.body.style.backgroundColor=Phaser.Color.getWebRGB(this.game.stage.backgroundColor),this.objetPause.panneau.destroy(),this.objetPause.texte.destroy();else{if(document.body.style.backgroundColor="#e7baf7",this.game.device.desktop)this.objetPause.panneau=this.game.add.sprite(0,0,"fondInstruction"),this.objetPause.texte=this.game.add.text(this.game.width/2,this.game.height/2,"Jeu sur pause. \nAppuyer sur 'P' pour continuer la partie",{font:"25px Monospace",fill:"white",align:"center"});else{this.objetPause.panneau=this.game.add.button(0,0,"fondInstruction",this.mettreSurPause,this,0),this.objetPause.panneau.scale.set(TetraBloc.RATIO_ECRAN.horizontal,TetraBloc.RATIO_ECRAN.vertical);var e=Math.round(30*TetraBloc.RATIO_ECRAN.moyen)+"px Monospace";this.objetPause.texte=this.game.add.text(this.game.width/2,this.game.height/2,"Jeu sur pause. \nToucher l'Ã©cran \npour continuer la partie.",{font:e,fill:"white",align:"center"})}this.objetPause.texte.anchor.set(.5)}},bougerGauche:function(){this.jouerSonClique(),this.testerCollision(0,-1)&&this.leTemps>this.prochaineAction+this.freqTemp&&(this.actualiserBloc(!1,!0,!1,!0),this.prochaineAction=this.game.time.totalElapsedSeconds())},bougerDroite:function(){this.jouerSonClique(),this.testerCollision(9,1)&&this.leTemps>this.prochaineAction+this.freqTemp&&(this.actualiserBloc(!1,!1,!0,!0),this.prochaineAction=this.game.time.totalElapsedSeconds())},bougerBas:function(){this.jouerSonClique(),this.leTemps>this.prochaineAction+this.freqTemp&&(this.faireTomberBloc(),this.prochaineAction=this.game.time.totalElapsedSeconds())},jouerSonClique:function(){if(!this.game.device.desktop){this.game.add.audio("clique").play()}},affecterMode:function(){switch(TetraBloc.mode){case 0:this.tempsLimite=!0,this.niveauLimite=!1,this.game.stage.backgroundColor=15923967,document.body.style.backgroundColor="#F2FAFF",this.vitesse=2;break;case 1:this.tempsLimite=!1,this.niveauLimite=!0,this.vitesse=2,this.game.stage.backgroundColor=16708833,document.body.style.backgroundColor="#FEF4E1";break;case 2:this.tempsLimite=!1,this.niveauLimite=!0,this.vitesse=10,this.game.stage.backgroundColor=16308183,document.body.style.backgroundColor="#F8D7D7";break;default:return}},creerJeu:function(){for(var e,t,i,s,a,r=0;r<TetraBloc.NB_BLOCS_PAR_COLONNES;r++){this.lesCases.push([]),this.tableauJeu.push([]),4>r&&(this.tableauProchainePiece.push([]),this.lesCasesProchainePieces.push([]),this.lesCasesPieceEnReserve.push([]),this.tableauPieceEnReserve.push([]));for(var o=0;o<TetraBloc.NB_BLOCS_PAR_RANGEES;o++)t=Math.floor(r+o/TetraBloc.NB_BLOCS_PAR_COLONNES)*TetraBloc.TAILLE_IMG*TetraBloc.RATIO_ECRAN.vertical,e=o%TetraBloc.NB_BLOCS_PAR_RANGEES*(TetraBloc.TAILLE_IMG*TetraBloc.RATIO_ECRAN.horizontal),4>r&&4>o&&(this.tableauProchainePiece[r].push(0),this.tableauPieceEnReserve[r].push(0),s=this.game.add.sprite(e+470*TetraBloc.RATIO_ECRAN.horizontal,t+93*TetraBloc.RATIO_ECRAN.vertical,"bloc",1),s.scale.set(TetraBloc.RATIO_ECRAN.horizontal,TetraBloc.RATIO_ECRAN.vertical),this.lesCasesProchainePieces[r][o]=s,a=this.game.add.sprite(e+470*TetraBloc.RATIO_ECRAN.horizontal,t+450*TetraBloc.RATIO_ECRAN.vertical,"bloc",1),a.scale.set(TetraBloc.RATIO_ECRAN.horizontal,TetraBloc.RATIO_ECRAN.vertical),this.lesCasesPieceEnReserve[r][o]=a),r>=4&&(i=this.game.add.sprite(e+75*TetraBloc.RATIO_ECRAN.horizontal,t-84*TetraBloc.RATIO_ECRAN.vertical,"bloc",1),i.scale.set(TetraBloc.RATIO_ECRAN.horizontal,TetraBloc.RATIO_ECRAN.vertical),this.lesCases[r][o]=i),this.tableauJeu[r].push(0)}},creerBoutons:function(){var e=this.game.add.button(this.game.width/6,this.game.height/1.135,"flecheBtn",this.bougerGauche,this,1,1,1,1);e.anchor.set(.5),e.scale.set(TetraBloc.RATIO_ECRAN.moyen,TetraBloc.RATIO_ECRAN.moyen);var t=this.game.add.button(this.game.width/2.5,this.game.height/1.07,"flecheBtn",this.bougerBas,this,0,0,0,0);t.anchor.set(.5),t.scale.set(TetraBloc.RATIO_ECRAN.moyen,TetraBloc.RATIO_ECRAN.moyen);var i=this.game.add.button(this.game.width/1.6,this.game.height/1.135,"flecheBtn",this.bougerDroite,this,2,2,2,2);i.anchor.set(.5),i.scale.set(TetraBloc.RATIO_ECRAN.moyen,TetraBloc.RATIO_ECRAN.moyen);var s=this.game.add.button(this.game.width/1.18,this.game.height/1.35,"flecheBtn",this.faireRotation,this,3,3,3,3);s.anchor.set(.5),s.scale.set(TetraBloc.RATIO_ECRAN.moyen,TetraBloc.RATIO_ECRAN.moyen);var a=this.game.add.button(this.game.width/1.18,this.game.height/1.83,"flecheBtn",this.mettreEnReserve,this,4,4,4,4);a.anchor.set(.5),a.scale.set(TetraBloc.RATIO_ECRAN.moyen,TetraBloc.RATIO_ECRAN.moyen);var r=this.game.add.button(75*TetraBloc.RATIO_ECRAN.horizontal,57*TetraBloc.RATIO_ECRAN.vertical,"pause",this.mettreSurPause,this,0);r.anchor.set(0,0),r.scale.set(TetraBloc.RATIO_ECRAN.horizontal,TetraBloc.RATIO_ECRAN.vertical),r.alpha=0},creerUnBloc:function(e){var t;e?(t=this.laPieceMettreEnJeu,this.etatPiece=t):(null==this.laProchainePiece?t=Math.floor(7*Math.random()+1):(t=this.laProchainePiece,this.reinitialiserMatrice(this.tableauProchainePiece)),this.laProchainePiece=Math.floor(7*Math.random()+1),this.assignerLaForme(this.laProchainePiece,!0),this.etatPiece=t),this.assignerLaForme(t);for(var i=0;4>i;i++)this.tableauJeu[this.laForme[i][0]][this.laForme[i][1]]=t;for(var i=0;4>i;i++){var s=2;1==this.laProchainePiece&&(s=3),this.tableauProchainePiece[this.laProchaineForme[i][0]-2][this.laProchaineForme[i][1]-s]=this.laProchainePiece}this.laBoucleTemps=this.game.time.events.loop(Phaser.Timer.SECOND/this.vitesse,this.faireTomberBloc,this),this.actualiserSprite(),this.actualiserSprite(!0,!1,4,4)},assignerLaForme:function(e,t,i){var s;switch(e){case 1:s=[[4,3],[4,4],[4,5],[4,6]];break;case 2:s=[[3,3],[3,4],[4,3],[4,4]];break;case 3:s=[[3,3],[4,4],[3,5],[3,4]];break;case 4:s=[[4,3],[4,4],[3,5],[3,4]];break;case 5:s=[[3,3],[4,4],[4,5],[3,4]];break;case 6:s=[[3,3],[4,3],[4,5],[4,4]];break;case 7:s=[[4,3],[4,5],[3,5],[4,4]]}t?this.laProchaineForme=s:i?this.reserveForme=s:this.laForme=s},actualiserSprite:function(e,t,i,s){var a,r,o=0;void 0==i&&void 0==s&&(i=TetraBloc.NB_BLOCS_PAR_COLONNES,s=TetraBloc.NB_BLOCS_PAR_RANGEES,o=4);for(var h=o;i>h;h++)for(var c=0;s>c;c++)switch(e?(a=this.tableauProchainePiece[h][c],r=this.lesCasesProchainePieces[h][c]):t?(a=this.tableauPieceEnReserve[h][c],r=this.lesCasesPieceEnReserve[h][c]):(a=this.tableauJeu[h][c],r=this.lesCases[h][c]),a){case 0:1!=r.frame&&(r.frame=1,r.tint=16777215);break;case 11:case 1:r.frame=0,r.tint=this.I_BLOC_COULEUR;break;case 12:case 2:r.frame=0,r.tint=this.O_BLOC_COULEUR;break;case 13:case 3:r.frame=0,r.tint=this.T_BLOC_COULEUR;break;case 14:case 4:r.frame=0,r.tint=this.S_BLOC_COULEUR;break;case 15:case 5:r.frame=0,r.tint=this.Z_BLOC_COULEUR;break;case 16:case 6:r.frame=0,r.tint=this.J_BLOC_COULEUR;break;case 17:case 7:r.frame=0,r.tint=this.L_BLOC_COULEUR;break;default:1!=r.frame&&(r.frame=1,r.tint=16777215)}},verifierMatriceJeu:function(){for(var e=0;e<TetraBloc.NB_BLOCS_PAR_RANGEES;e++)this.tableauJeu[TetraBloc.LIGNE_DE_DEPART][e]>10&&this.finJeu();for(var t=0,e=0;e<TetraBloc.NB_BLOCS_PAR_COLONNES;e++){for(var i=0;i<TetraBloc.NB_BLOCS_PAR_RANGEES;i++)0!=this.tableauJeu[e][i]&&(t+=1),t==TetraBloc.NB_BLOCS_PAR_RANGEES&&this.detruireLigne(e);t=0}},detruireLigne:function(e){this.game.add.audio("pop").play(),this.tableauJeu.splice(e,1),this.tableauJeu.unshift([0,0,0,0,0,0,0,0,0,0]),this.score+=10+10*this.nbLignesDetruitesDunCoup/2,this.nbLignesDetruitesDunCoup+=1,this.nbLignesDetruitesTotal+=1;var t;switch(this.nbLignesDetruitesDunCoup){case 1:t=15066368;break;case 2:t=14267157;break;case 3:t=15771668;break;case 4:t=12063764}if(new AnimEtoile(this.game,this.game.width/8,this.lesCases[e][0].y+20*TetraBloc.RATIO_ECRAN.vertical,0,t),this.nbLignesDetruitesTotal>=10&&this.nbLignesDetruitesTotal%10==0){this.niveau++,this.niveauTxt.text="Niveau: "+this.niveau,this.vitesse+=.5,this.game.add.audio("niveau").play();var i="bold "+Math.round(50*TetraBloc.RATIO_ECRAN.moyen)+"px Monospace",s={font:i,fill:"darkred",align:"center"};new ExplosionPoint(this.game,this.game.width/2.5,this.game.height/3,this.niveauTxt.text,s)}this.scoreTxt.text="Score: "+this.score,this.actualiserSprite(),this.niveauLimite&&this.niveau===TetraBloc.NB_NIVEAUX_POUR_GAGNER&&this.finJeu()},finJeu:function(){this.laMusique.stop(),this.game.state.start("ecranFinJeu",!0,!1,this.score)},augmenterTemps:function(){if(this.blocActif&&(this.tempsEcoule++,this.tempsTxt.text="Temps:  "+this.tempsEcoule,this.tempsLimite&&this.tempsEcoule==TetraBloc.TEMPS_LIMITE&&this.finJeu(),this.tempsLimite&&10>TetraBloc.TEMPS_LIMITE-this.tempsEcoule)){var e=TetraBloc.TEMPS_LIMITE-this.tempsEcoule,t="bold "+Math.round(60*TetraBloc.RATIO_ECRAN.moyen)+"px Arial",i={font:t,fill:"darkred",align:"center"};new ExplosionPoint(this.game,this.game.width/2.5,this.game.height/3,e,i)}},desactiverBloc:function(e){this.game.time.events.remove(this.laBoucleTemps),this.etatRotation=0,this.blocActif=!1,this.verifierMatriceJeu(),this.blocActif=!0,e&&null!=this.laPieceMettreEnJeu?this.creerUnBloc(!0):this.creerUnBloc(),this.nbLignesDetruitesDunCoup=0,e||(this.reserveUtilise=!1)},faireTomberBloc:function(){if(this.blocActif)if(this.laForme[0][0]!=TetraBloc.NB_BLOCS_PAR_COLONNES-1&&this.laForme[3][0]!=TetraBloc.NB_BLOCS_PAR_COLONNES-1&&this.laForme[2][0]!=TetraBloc.NB_BLOCS_PAR_COLONNES-1&&this.laForme[1][0]!=TetraBloc.NB_BLOCS_PAR_COLONNES-1){for(var e=0;4>e;e++)this.tableauJeu[this.laForme[e][0]+1][this.laForme[e][1]]>10&&this.etatPiece<10&&(this.etatPiece=parseInt("1"+this.etatPiece));if(this.etatPiece>10){for(var e=0;4>e;e++)this.tableauJeu[this.laForme[e][0]][this.laForme[e][1]]=this.etatPiece;return void this.desactiverBloc()}this.actualiserBloc(!0,!1,!1,!0)}else{for(var e=0;4>e;e++)this.tableauJeu[this.laForme[e][0]][this.laForme[e][1]]=this.tableauJeu[this.laForme[e][0]][this.laForme[e][1]]+10;this.desactiverBloc()}},actualiserBloc:function(e,t,i){for(var s=0;4>s;s++)this.tableauJeu[this.laForme[s][0]][this.laForme[s][1]]=0,e&&(this.laForme[s][0]+=1),i&&(this.laForme[s][1]+=1),t&&(this.laForme[s][1]-=1);for(var s=0;4>s;s++)this.tableauJeu[this.laForme[s][0]][this.laForme[s][1]]=this.etatPiece;this.actualiserSprite()},testerCollision:function(e,t){for(var i=0;4>i;i++){if(0==e&&this.laForme[i][1]-1<e)return!1;if(e>0&&this.laForme[i][1]+1>e)return!1;if(this.tableauJeu[this.laForme[i][0]][this.laForme[i][1]+1*t]>10)return!1}return!0},faireRotation:function(){if(this.blocActif){if(this.game.add.audio("clique").play(),2==this.etatPiece)return;var e=this.objetRotations.getValeurRotation(this.etatPiece),t=3;1==this.etatPiece&&(t=4);for(var i=0;4>i;i++)this.tableauJeu[this.laForme[i][0]][this.laForme[i][1]]=0;var s=this.testertCollisionRotation(e,t);if(s){for(i=0;t>i;i++)this.laForme[i][0]+=e[this.etatRotation][0][i],this.laForme[i][1]+=e[this.etatRotation][1][i];this.etatRotation+=1}4==this.etatRotation&&(this.etatRotation=0);for(var i=0;4>i;i++)this.tableauJeu[this.laForme[i][0]][this.laForme[i][1]]=this.etatPiece;this.actualiserSprite()}},reinitialiserMatrice:function(e){for(var t=0;4>t;t++)for(var i=0;4>i;i++)e[t][i]=0},mettreEnReserve:function(){if(this.blocActif&&(this.game.add.audio("clique").play(),0==this.reserveUtilise)){this.reserveUtilise=!0,this.laPieceMettreEnJeu=this.laPieceEnReserve,this.laPieceEnReserve=this.etatPiece;for(var e=0;4>e;e++)this.tableauJeu[this.laForme[e][0]][this.laForme[e][1]]=0;this.reinitialiserMatrice(this.tableauPieceEnReserve),this.assignerLaForme(this.etatPiece,!1,!0);for(var e=0;4>e;e++){var t=2;1==this.etatPiece&&(t=3),this.tableauPieceEnReserve[this.reserveForme[e][0]-2][this.reserveForme[e][1]-t]=this.etatPiece}this.actualiserSprite(!1,!0,4,4),this.desactiverBloc(!0)}},testertCollisionRotation:function(e,t){if(void 0==e)return!1;for(var i=JSON.parse(JSON.stringify(this.tableauJeu)),s=JSON.parse(JSON.stringify(this.laForme)),a=0;t>a;a++){if(s[a][0]+=e[this.etatRotation][0][a],s[a][1]+=e[this.etatRotation][1][a],s[a][0]>=TetraBloc.NB_BLOCS_PAR_COLONNES)return!1;if(i[s[a][0]][s[a][1]]>10||void 0==i[s[a][0]][s[a][1]])return!1}return!0},objetRotations:{1:{0:[[-2,-1,0,1],[1,0,-1,-2]],1:[[1,0,-1,-2],[2,1,0,-1]],2:[[2,1,0,-1],[-1,0,1,2]],3:[[-1,0,1,2],[-2,-1,0,1]]},3:{0:[[-1,-1,1],[1,-1,-1]],1:[[1,-1,-1],[1,1,-1]],2:[[1,1,-1],[-1,1,1]],3:[[-1,1,1],[-1,-1,1]]},4:{0:[[-2,-1,1],[0,-1,-1]],1:[[0,-1,-1],[2,1,-1]],2:[[2,1,-1],[0,1,1]],3:[[0,1,1],[-2,-1,1]]},5:{0:[[-1,-1,0],[1,-1,-2]],1:[[1,-1,-2],[1,1,0]],2:[[1,1,0],[-1,1,2]],3:[[-1,1,2],[-1,-1,0]]},6:{0:[[0,1,-1],[2,1,-1]],1:[[2,-1,1],[0,1,-1]],2:[[0,1,-1],[-2,-1,1]],3:[[-2,-1,1],[0,-1,1]]},7:{0:[[-1,1,2],[1,-1,0]],1:[[1,-1,0],[1,-1,-2]],2:[[1,-1,-2],[-1,1,0]],3:[[-1,1,0],[-1,1,2]]},getValeurRotation:function(e){return this[e]}}};